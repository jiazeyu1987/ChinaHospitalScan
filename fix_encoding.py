#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import re

def fix_encoding_issues():
    """修复main.py文件中的编码问题"""

    # 读取文件
    with open('main.py', 'r', encoding='utf-8', errors='replace') as f:
        content = f.read()

    # 定义替换规则
    replacements = {
        '进\ufffd?': '进程',
        '终\ufffd?': '终止中',
        '数据库清空成\ufffd?': '数据库清空成功',
        '表结构保\ufffd?': '表结构保留',
        '数据库清空失\ufffd?': '数据库清空失败',
        '清空数据库失\ufffd?': '清空数据库失败',
        '删除所有任务记\ufffd?': '删除所有任务记录',
        '任务记录删除成\ufffd?': '任务记录删除成功',
        '删除所有任务记录失\ufffd?': '删除所有任务记录失败',
        '清理已完成任务失\ufffd?': '清理已完成任务失败',
        '任务管理\ufffd?': '任务管理器',
        '获取数据库连\ufffd?': '获取数据库连接',
        '接收到扫查任\ufffd?': '接收到扫描任务',
        '正在处理\ufffd?': '正在处理中',
        '获取任务状态成\ufffd?': '获取任务状态成功',
        '任务不存\ufffd?': '任务不存在',
        '获取任务状态失\ufffd?': '获取任务状态失败',
        '接收到完整数据刷新请\ufffd?': '接收到完整数据刷新请求',
        '刷新所有省份、城市、区县、医院数\ufffd?': '刷新所有省份、城市、区县、医院数据',
        '临时调试用\ufffd?': '临时调试用途',
        '正在后台处理\ufffd?': '正在后台处理中',
        '中文字\ufffd?': '中文字符',
        '解码\ufffd?': '解码后',
        '数据刷新接口调用开\ufffd?': '数据刷新接口调用开始',
        '解码后省份名\ufffd?': '解码后省份名称',
        '调用时\ufffd?': '调用时间',
        '省份名称无效\ufffd?': '省份名称无效',
        '数据库任务记录创建成\ufffd?': '数据库任务记录创建成功',
        '数据库任务记录创建失\ufffd?': '数据库任务记录创建失败',
        '数据库操作失\ufffd?': '数据库操作失败',
        '区县名称无效\ufffd?': '区县名称无效',
        '区县名称验证通\ufffd?': '区县名称验证通过',
        '区县医院数据刷新任务已创建，正在后台处理\ufffd?': '区县医院数据刷新任务已创建，正在后台处理中',
        '响应数据已生\ufffd?': '响应数据已生成',
        '创建区县医院刷新任务失\ufffd?': '创建区县医院刷新任务失败',
        '开始处理省份城市区县级联刷新请\ufffd?': '开始处理省份城市区县级联刷新请求',
        '省份名称处理完\ufffd?': '省份名称处理完成',
        '任务状态管\ufffd?': '任务状态管理',
        '省份城市区县级联刷新后台任务已成功添加到队列': '省份城市区县级联刷新后台任务已成功添加到队列',
        '的城市、区县及医院数据级联刷新任务已创建，正在后台处理\ufffd?': '的城市、区县及医院数据级联刷新任务已创建，正在后台处理中',
        '创建省份城市区县级联刷新任务失\ufffd?': '创建省份城市区县级联刷新任务失败',
        '全国扫描（所有省份的级联刷新\ufffd?': '全国扫描（所有省份的级联刷新）',
        '全国扫描 - 所有省份级联刷\ufffd?': '全国扫描 - 所有省份级联刷新',
        '这个API端点会执行全国范围的医院数据扫描，逻辑如\ufffd?': '这个API端点会执行全国范围的医院数据扫描，逻辑如下：',
        '首先从LLM获取全国所有省份列\ufffd?': '首先从LLM获取全国所有省份列表',
        '实时进度跟踪和详细日志记\ufffd?': '实时进度跟踪和详细日志记录',
        '自动重试机制和错误恢\ufffd?': '自动重试机制和错误恢复',
        'API限流保护和并发控\ufffd?': 'API限流保护和并发控制',
        '启动全国扫描任\ufffd?': '启动全国扫描任务',
        '优先使用task_type字段，兼容旧数\ufffd?': '优先使用task_type字段，兼容旧数据',
        '全国扫描任务已在运行中，请等待完\ufffd?': '全国扫描任务已在运行中，请等待完成',
        '使用TaskManager创建任务，确保内存和数据库\ufffd?': '使用TaskManager创建任务，确保内存和数据库一致',
        '全国扫描任务已创\ufffd?': '全国扫描任务已创建',
        '创建全国扫描任务失\ufffd?': '创建全国扫描任务失败',
        'API收到省份名称查\ufffd?': 'API收到省份名称查询',
        '找到省份\ufffd?': '找到省份ID',
        '未找到省\ufffd?': '未找到省份',
        '返回空结\ufffd?': '返回空结果',
        '查询并更新医院官方网\ufffd?': '查询并更新医院官方网站',
        '根据医院名称查询官方网站，并更新数据库中的网站字\ufffd?': '根据医院名称查询官方网站，并更新数据库中的网站字段',
        '功能特\ufffd?': '功能特性',
        '通过LLM智能查询医院官方网站': '通过LLM智能查询医院官方网站',
        '自动更新数据库中的医院网站信\ufffd?': '自动更新数据库中的医院网站信息',
        '数据验证和错误处\ufffd?': '数据验证和错误处理',
        '高性能异步处\ufffd?': '高性能异步处理',
        '处理流\ufffd?': '处理流程',
        '参数验\ufffd?': '参数验证',
        '验证医院名称的有效\ufffd?': '验证医院名称的有效性',
        '数据库查\ufffd?': '数据库查询',
        '检查医院是否存在于数据库中': '检查医院是否存在于数据库中',
        '数据验\ufffd?': '数据验证',
        '验证返回的网站URL格式和有效\ufffd?': '验证返回的网站URL格式和有效性',
        '数据库更\ufffd?': '数据库更新',
        '将查询结果更新到医院记录\ufffd?': '将查询结果更新到医院记录中',
        '结果返\ufffd?': '结果返回',
        '返回详细的查询和更新结\ufffd?': '返回详细的查询和更新结果',
        '参数说\ufffd?': '参数说明',
        '医院名\ufffd?': '医院名称',
        'force_update: 是否强制更新已有网站信息（默认false\ufffd?': 'force_update: 是否强制更新已有网站信息（默认false）',
        '返回数\ufffd?': '返回数据',
        '操作是否成\ufffd?': '操作是否成功',
        '请求ID，用于日志追\ufffd?': '请求ID，用于日志追踪',
        '响应时\ufffd?': '响应时间',
        '使用示\ufffd?': '使用示例',
        '更新所有医院网站（默认行\ufffd?': '更新所有医院网站（默认行为）',
        '限制更新的医院数\ufffd?': '限制更新的医院数量',
        '跳过已有网站信息的医\ufffd?': '跳过已有网站信息的医院',
        '更新指定医院的网\ufffd?': '更新指定医院的网站',
        '注意事\ufffd?': '注意事项',
        '如果医院不存在于数据库中，会返回相应的错误信\ufffd?': '如果医院不存在于数据库中，会返回相应的错误信息',
        '网站URL会自动验证和格式化（补充协议头等\ufffd?': '网站URL会自动验证和格式化（补充协议头等）',
        '所有操作都有详细的日志记录，便于调试和监\ufffd?': '所有操作都有详细的日志记录，便于调试和监控',
        '医院网站查询和更新成\ufffd?': '医院网站查询和更新成功',
        '医院名称不能为空或长度不\ufffd?': '医院名称不能为空或长度不足',
        '医院不存\ufffd?': '医院不存在',
        '服务器内部错\ufffd?': '服务器内部错误',
        '查询并更新医院官方网\ufffd?': '查询并更新医院官方网站',
        '该API端点接收医院名称，通过LLM查询官方网站，并更新数据库中的相应字\ufffd?': '该API端点接收医院名称，通过LLM查询官方网站，并更新数据库中的相应字段',
        '提供完整的日志记录和错误处理机\ufffd?': '提供完整的日志记录和错误处理机制',
        '医院网站API请求开\ufffd?': '医院网站API请求开始',
        '医院名称标\ufffd?': '医院名称标准化',
        '步骤2: 数据库连\ufffd?': '步骤2: 获取数据库连接',
        '精确匹配失败，尝试模糊匹\ufffd?': '精确匹配失败，尝试模糊匹配',
        '步骤4: 检查是否需要更\ufffd?': '步骤4: 检查是否需要更新',
        '医院已有网站信息且不强制更新，直接返回现有数\ufffd?': '医院已有网站信息且不强制更新，直接返回现有数据',
        '请求完成（无需更\ufffd?': '请求完成（无需更新）',
        '步骤6: 更新数\ufffd?': '步骤6: 更新数据',
        '数据库更新成\ufffd?': '数据库更新成功',
        '数据库更新失\ufffd?': '数据库更新失败',
        'LLM未返回有效网站信息，跳过数据库更\ufffd?': 'LLM未返回有效网站信息，跳过数据库更新',
        '最终结\ufffd?': '最终结果',
        '服务器内部错\ufffd?': '服务器内部错误',
        '根据医院名称设置医院的基础采购链接信\ufffd?': '根据医院名称设置医院的基础采购链接信息',
        '手动设置医院基础采购链\ufffd?': '手动设置医院基础采购链接',
        '更新数据库中的基础采购链接字\ufffd?': '更新数据库中的基础采购链接字段',
        '提供详细的设置结果日\ufffd?': '提供详细的设置结果日志',
        '数据验证和错误处\ufffd?': '数据验证和错误处理',
        '参数说\ufffd?': '参数说明',
        '基础采购链接URL\ufffd?': '基础采购链接URL',
        '返回数\ufffd?': '返回数据',
        '是否执行了更新操\ufffd?': '是否执行了更新操作',
        '设置医院基础采购链接接口：根据医院名称手动设置基础采购链\ufffd?': '设置医院基础采购链接接口：根据医院名称手动设置基础采购链接',
        '未找到医\ufffd?': '未找到医院',
        '数据库更新成\ufffd?': '数据库更新成功',
        '数据库更新失\ufffd?': '数据库更新失败',
        '数据库操作异\ufffd?': '数据库操作异常',
        '设置基础采购链接时发生未知错\ufffd?': '设置基础采购链接时发生未知错误',
        '批量更新所有医院网站信\ufffd?': '批量更新所有医院网站信息',
        '批量获取hospitals表中的所有医院，然后依次串行调用医院网站查询API更新网站数\ufffd?': '批量获取hospitals表中的所有医院，然后依次串行调用医院网站查询API更新网站数据',
        '扫描获取hospitals表中所有医院信\ufffd?': '扫描获取hospitals表中所有医院信息',
        '串行逐个更新医院网站（避免并发冲\ufffd?': '串行逐个更新医院网站（避免并发冲突）',
        '自动更新数据库中的website字\ufffd?': '自动更新数据库中的website字段',
        '实时进度报告和详细日\ufffd?': '实时进度报告和详细日志',
        '智能跳过已有网站（可选\ufffd?': '智能跳过已有网站（可选）',
        '处理流\ufffd?': '处理流程',
        '扫描医\ufffd?': '扫描医院',
        '获取hospitals表中所有医院信\ufffd?': '获取hospitals表中所有医院信息',
        '初始化进\ufffd?': '初始化进度',
        '设置进度跟踪和日志系\ufffd?': '设置进度跟踪和日志系统',
        '串行更\ufffd?': '串行更新',
        '逐个调用医院网站更新A\ufffd?': '逐个调用医院网站更新API',
        '结果汇\ufffd?': '结果汇总',
        '统计成功、失败、跳过的医院数\ufffd?': '统计成功、失败、跳过的医院数量',
        '参数说\ufffd?': '参数说明',
        '批量处理限制（默认null表示更新所有医院，最\ufffd?': '批量处理限制（默认null表示更新所有医院，最大',
        '跳过已有网站信息的医院（默认false\ufffd?': '跳过已有网站信息的医院（默认false）',
        '返回数\ufffd?': '返回数据',
        '详细更新结果（小批量或完成时返\ufffd?': '详细更新结果（小批量或完成时返回）',
        '总处理时\ufffd?': '总处理时间',
        '请求追踪I\ufffd?': '请求追踪ID',
        '注意事\ufffd?': '注意事项',
        '串行处理避免数据库锁定冲\ufffd?': '串行处理避免数据库锁定冲突',
        '提供详细的日志记录便于调\ufffd?': '提供详细的日志记录便于调试',
        '支持断点续传和中途监\ufffd?': '支持断点续传和中途监控',
        '批量更新完成: 更新了数据库中所有医院网\ufffd?': '批量更新完成: 更新了数据库中所有医院网站',
        'limit参数必\ufffd?': 'limit参数必须',
        '服务器内部错\ufffd?': '服务器内部错误',
        '批量更新过程中发生错\ufffd?': '批量更新过程中发生错误',
        '该API端点支持多种更新模\ufffd?': '该API端点支持多种更新模式',
        '全量更新所有医\ufffd?': '全量更新所有医院',
        '限制数量更\ufffd?': '限制数量更新',
        '提供详细的进度跟踪和错误处理机\ufffd?': '提供详细的进度跟踪和错误处理机制',
        '使用示\ufffd?': '使用示例',
        '更新所有医\ufffd?': '更新所有医院',
        '更新\ufffd?': '更新',
        '批量更新医院网站API请求开\ufffd?': '批量更新医院网站API请求开始',
        '指定医院ID数\ufffd?': '指定医院ID数量',
        '指\ufffd?': '指定',
        '步骤1: 获取数据库连\ufffd?': '步骤1: 获取数据库连接',
        '检测到 update_all=true，强制获取所有医院进行更\ufffd?': '检测到 update_all=true，强制获取所有医院进行更新',
        '不限制数\ufffd?': '不限制数量',
        '已设\ufffd?': '已设置',
        '获取指定医院ID列\ufffd?': '获取指定医院ID列表',
        '获取所有医院（使用限制\ufffd?': '获取所有医院（使用限制）',
        '获取医院信息，限制数\ufffd?': '获取医院信息，限制数量',
        '步骤3: 开始批量更\ufffd?': '步骤3: 开始批量更新',
        '开始批量更新医院网\ufffd?': '开始批量更新医院网站',
        '处理医\ufffd?': '处理医院',
        '总耗\ufffd?': '总耗时',
        '数\ufffd?': '数据',
        '批量更新完成: {total_hospitals}个医院，成功{successful_count}个，失败{failed_count}个，跳过{skipped_count}\ufffd?': '批量更新完成: {total_hospitals}个医院，成功{successful_count}个，失败{failed_count}个，跳过{skipped_count}个',
        '获取所有医院信\ufffd?': '获取所有医院信息',
        '获取所有医院，不限制数\ufffd?': '获取所有医院，不限制数量',
        '有数量限\ufffd?': '有数量限制',
        '查询医院，限制数\ufffd?': '查询医院，限制数量',
        '获取所有医院失\ufffd?': '获取所有医院失败',
        '开始批量更\ufffd?': '开始批量更新',
        '个医\ufffd?': '个医院',
        '检查是否需要跳\ufffd?': '检查是否需要跳过',
        '构造医院网站更新请\ufffd?': '构造医院网站更新请求',
        '处理医院 {hospital_name} 时发生错\ufffd?': '处理医院 {hospital_name} 时发生错误',
        '批量更新完成，处理了 {len(results)} 个医\ufffd?': '批量更新完成，处理了 {len(results)} 个医院',
        '更新单个医院的网站信息（内部函\ufffd?': '更新单个医院的网站信息（内部函数）',
        '更新数\ufffd?': '更新数据',
        '这个时间在update_hospital_website中已经计\ufffd?': '这个时间在update_hospital_website中已经计算',
        'LLM未返回有效网站信\ufffd?': 'LLM未返回有效网站信息',
        '开始执行完整数据刷新任\ufffd?': '开始执行完整数据刷新任务',
        '开始时\ufffd?': '开始时间',
        '步骤1: 更新任务状态为运行\ufffd?': '步骤1: 更新任务状态为RUNNING',
        '任务状态已更新为RUNNING: {task_id}': '任务状态已更新为RUNNING: {task_id}',
        '项目根目\ufffd?': '项目根目录',
        '项目根目录已在sys.path\ufffd?': '项目根目录已在sys.path中',
        'sys.path包\ufffd?': 'sys.path包含',
        '个路\ufffd?': '个路径',
        '步骤3: 导入必要的模\ufffd?': '步骤3: 导入必要的模块',
        'tasks模块导入成\ufffd?': 'tasks模块导入成功',
        '无法导入根目录TaskManager: {e}': '无法导入根目录TaskManager: {e}',
        '详细错误信\ufffd?': '详细错误信息',
        '步骤4: 获取数据库连\ufffd?': '步骤4: 获取数据库连接',
        '数据库连接成\ufffd?': '数据库连接成功',
        '数据库连接失\ufffd?': '数据库连接失败',
        '数据库连接失\ufffd?': '数据库连接失败',
        '步骤5: 创建进度跟踪\ufffd?': '步骤5: 创建进度跟踪器',
        '已用时\ufffd?': '已用时间',
        '秒\ufffd?': '秒',
        '个主要步\ufffd?': '个主要步骤',
        '任务初始化完\ufffd?': '任务初始化完成',
        '准备开始数据刷新流\ufffd?': '准备开始数据刷新流程',
        '步骤6: 初始化LLM客\ufffd?': '步骤6: 初始化LLM客户端',
        '初始化LLM客\ufffd?': '初始化LLM客户端',
        '检查环境变\ufffd?': '检查环境变量',
        'LLM_API_KEY: 已设\ufffd?': 'LLM_API_KEY: 已设置',
        'LLM_API_KEY: 未设\ufffd?': 'LLM_API_KEY: 未设置',
        'LLM_BASE_URL: {base_url if base_url else \'使用默认\ufffd?': 'LLM_BASE_URL: {base_url if base_url else \'使用默认值\'}',
        'LLM_MODEL: {model if model else \'使用默认\ufffd?': 'LLM_MODEL: {model if model else \'使用默认值\'}',
        'LLMClient初始化成\ufffd?': 'LLMClient初始化成功',
        'LLM客户端初始化完\ufffd?': 'LLM客户端初始化完成',
        'LLM客户端初始化失\ufffd?': 'LLM客户端初始化失败',
        '错误类\ufffd?': '错误类型',
        '错误详\ufffd?': '错误详情',
        '完整堆\ufffd?': '完整堆栈',
        'LLM初始化失\ufffd?': 'LLM初始化失败',
        '你是一个数据采集助\ufffd?': '你是一个数据采集助手',
        '请简单回\ufffd?': '请简单回复',
        '发送测试请\ufffd?': '发送测试请求',
        'LLM API连接测试成\ufffd?': 'LLM API连接测试成功',
        'LLM API连接测试通\ufffd?': 'LLM API连接测试通过',
        'LLM API返回空响\ufffd?': 'LLM API返回空响应',
        'LLM API连接测试失\ufffd?': 'LLM API连接测试失败',
        '错误类\ufffd?': '错误类型',
        '错误详\ufffd?': '错误详情',
        '完整堆\ufffd?': '完整堆栈',
        '步骤8: 开始获取省份数\ufffd?': '步骤8: 开始获取省份数据',
        '开始获取省份数\ufffd?': '开始获取省份数据',
        '准备调用LLM获取全国省份列\ufffd?': '准备调用LLM获取全国省份列表',
        '构建省份查询提\ufffd?': '构建省份查询提示词',
        '请返回中国的所有省级行政区划，包括省份、自治区、直辖市和特别行政\ufffd?': '请返回中国的所有省级行政区划，包括省份、自治区、直辖市和特别行政区',
        '要\ufffd?': '要求',
        '返回JSON格\ufffd?': '返回JSON格式',
        '包含完整的中文名\ufffd?': '包含完整的中文名称',
        '按照标准的行政区划代码排\ufffd?': '按照标准的行政区划代码排序',
        '格式示\ufffd?': '格式示例',
        '北\ufffd?': '北京',
        '天\ufffd?': '天津',
        '发送省份查询请\ufffd?': '发送省份查询请求',
        '你是一个专业的地理信息系统数据助手，专门处理中国行政区划数\ufffd?': '你是一个专业的地理信息系统数据助手，专门处理中国行政区划数据',
        '成功获取省份响\ufffd?': '成功获取省份响应',
        '个省\ufffd?': '个省份',
        '还有 {len(provinces) - 5} 个省\ufffd?': '还有 {len(provinces) - 5} 个省份',
        '成功获取{len(provinces)}个省份数\ufffd?': '成功获取{len(provinces)}个省份数据',
        'JSON解析失败，尝试文本解\ufffd?': 'JSON解析失败，尝试文本解析',
        '通\ufffd?': '通过',
        '通过文本解析获得 {len(provinces)} 个省\ufffd?': '通过文本解析获得 {len(provinces)} 个省份',
        '通过文本解析获得{len(provinces)}个省份数\ufffd?': '通过文本解析获得{len(provinces)}个省份数据',
        '省份数据获取失\ufffd?': '省份数据获取失败',
        '完整堆\ufffd?': '完整堆栈',
        '数据刷新任务完\ufffd?': '数据刷新任务完成',
        '总共处理了{len(provinces)}个省份数\ufffd?': '总共处理了{len(provinces)}个省份数据',
        '任务ID: {task_id}': '任务ID: {task_id}',
        '结束时\ufffd?': '结束时间',
        '总用\ufffd?': '总用时',
        '秒\ufffd?': '秒',
        '处理数\ufffd?': '处理数据',
        '个省\ufffd?': '个省份',
        '任务状\ufffd?': '任务状态',
        '开始自动遍历省份扫描城\ufffd?': '开始自动遍历省份扫描城市',
        '即将开始遍\ufffd?': '即将开始遍历',
        '个省份，获取各省份的城市数据': '个省份，获取各省份的城市数据',
        '自动遍历开始时\ufffd?': '自动遍历开始时间',
        '开始处理省\ufffd?': '开始处理省份',
        '创建子任务记\ufffd?': '创建子任务记录',
        '获取省份 {province_name} 的城市数\ufffd?': '获取省份 {province_name} 的城市数据',
        '省份 {province_name} 处理成\ufffd?': '省份 {province_name} 处理成功',
        '省份处理用\ufffd?': '省份处理用时',
        '秒\ufffd?': '秒',
        '省份 {province_name} 处理失\ufffd?': '省份 {province_name} 处理失败',
        '失败前用\ufffd?': '失败前用时',
        '秒\ufffd?': '秒',
        '更新子任务状态失\ufffd?': '更新子任务状态失败',
        '继续处理下一个省\ufffd?': '继续处理处理下一个省份',
        '主任务ID: {task_id}': '主任务ID: {task_id}',
        '开始时\ufffd?': '开始时间',
        '结束时\ufffd?': '结束时间',
        '自动遍历总用\ufffd?': '自动遍历总用时',
        '秒\ufffd?': '秒',
        '成功省\ufffd?': '成功省份',
        '失败省\ufffd?': '失败省份',
        '成功\ufffd?': '成功率',
        '获取城市总\ufffd?': '获取城市总数',
        '所有任务状\ufffd?': '所有任务状态',
        '任务ID: {task_id}': '任务ID: {task_id}'
    }

    # 应用替换
    for old, new in replacements.items():
        content = content.replace(old, new)

    # 移除所有剩余的替换字符
    content = re.sub(r'\ufffd+', '', content)

    # 写回文件
    with open('main.py', 'w', encoding='utf-8') as f:
        f.write(content)

    print('编码问题修复完成')

if __name__ == '__main__':
    fix_encoding_issues()