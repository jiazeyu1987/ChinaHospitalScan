# HBScan API 接口文档

## 服务概述
HBScan 是一个基于大语言模型的医院层级结构自动扫查服务，提供全国范围的省、市、区县、医院四级数据的采集、查询和管理功能。

**基础信息：**
- 基础URL: `http://localhost:8000`
- 数据格式: JSON
- 字符编码: UTF-8
- 支持中文字符参数

---

## 系统管理接口

### 1. 清空所有任务记录
**接口：** `DELETE /tasks/clear`

**功能描述：** 删除所有任务记录，用于清理任务历史数据

**请求参数：** 无

**响应示例：**
```json
{
  "code": 200,
  "message": "所有任务记录已成功删除",
  "data": {
    "status": "success",
    "cleared_at": "2025-11-23T15:30:45.123456"
  }
}
```

**使用场景：**
- 定期清理历史任务数据
- 系统维护前重置任务状态
- 测试环境数据清理

---

### 2. 健康检查
**接口：** `GET /health`

**功能描述：** 检查服务运行状态

**请求参数：** 无

**响应示例：**
```json
{
  "status": "healthy"
}
```

**使用场景：**
- 服务监控和健康检查
- 负载均衡器状态探测
- 容器化部署的存活检查

---

## 数据查询接口

### 3. 获取省份列表
**接口：** `GET /provinces`

**功能描述：** 获取全国省级行政区划列表，支持分页

**请求参数：**
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认20

**请求示例：**
```
GET /provinces?page=1&page_size=20
```

**响应示例：**
```json
{
  "items": [
    {
      "id": 1,
      "name": "北京市",
      "code": "110000",
      "created_at": "2025-11-23T10:00:00"
    },
    {
      "id": 2,
      "name": "上海市",
      "code": "310000",
      "created_at": "2025-11-23T10:00:01"
    }
  ],
  "total": 34,
  "page": 1,
  "page_size": 20,
  "pages": 2,
  "has_next": true,
  "has_prev": false
}
```

**使用场景：**
- 获取全国省份列表用于下拉选择
- 省份数据统计分析
- 地理信息系统基础数据

---

### 4. 获取城市列表
**接口：** `GET /cities`

**功能描述：** 获取指定省份下的城市列表，支持分页

**请求参数：**
- `province` (可选): 省份名称（中文），支持URL编码
- `province_id` (可选): 省份ID（数字）
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认20

**请求示例：**
```
GET /cities?province=广东省&page=1&page_size=20
GET /cities?province_id=19&page=1&page_size=50
```

**响应示例：**
```json
{
  "items": [
    {
      "id": 201,
      "name": "广州市",
      "province_id": 19,
      "created_at": "2025-11-23T10:05:00"
    },
    {
      "id": 202,
      "name": "深圳市",
      "province_id": 19,
      "created_at": "2025-11-23T10:05:01"
    }
  ],
  "total": 21,
  "page": 1,
  "page_size": 20,
  "pages": 2,
  "has_next": true,
  "has_prev": false
}
```

**使用场景：**
- 根据省份获取下属城市列表
- 级联选择器的城市数据源
- 区域性数据分析

---

### 5. 获取区县列表
**接口：** `GET /districts`

**功能描述：** 获取指定城市下的区县列表，支持分页

**请求参数：**
- `city` (可选): 城市名称（中文），支持URL编码
- `city_id` (可选): 城市ID（数字）
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认20

**请求示例：**
```
GET /districts?city=广州市&page=1&page_size=20
GET /districts?city_id=201&page=1&page_size=30
```

**响应示例：**
```json
{
  "items": [
    {
      "id": 3001,
      "name": "越秀区",
      "city_id": 201,
      "created_at": "2025-11-23T10:10:00"
    },
    {
      "id": 3002,
      "name": "海珠区",
      "city_id": 201,
      "created_at": "2025-11-23T10:10:01"
    }
  ],
  "total": 11,
  "page": 1,
  "page_size": 20,
  "pages": 1,
  "has_next": false,
  "has_prev": false
}
```

**使用场景：**
- 获取城市下属区县信息
- 精确定位到医院所在区域
- 城市规划和区域分析

---

### 6. 获取医院列表
**接口：** `GET /hospitals`

**功能描述：** 获取指定区县下的医院列表，支持分页

**请求参数：**
- `district` (可选): 区县名称（中文），支持URL编码
- `district_id` (可选): 区县ID（数字）
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认20

**请求示例：**
```
GET /hospitals?district=越秀区&page=1&page_size=20
GET /hospitals?district_id=3001&page=1&page_size=50
```

**响应示例：**
```json
{
  "items": [
    {
      "id": 10001,
      "name": "广东省人民医院",
      "district_id": 3001,
      "level": "三级甲等",
      "address": "广州市越秀区中山二路106号",
      "phone": "020-83827812",
      "website": "www.gdph.org.cn",
      "beds_count": 2800,
      "departments": ["内科", "外科", "妇产科", "儿科"],
      "created_at": "2025-11-23T10:15:00"
    }
  ],
  "total": 15,
  "page": 1,
  "page_size": 20,
  "pages": 1,
  "has_next": false,
  "has_prev": false
}
```

**使用场景：**
- 区域医疗资源查询
- 医院信息统计分析
- 就医指南和导航服务

---

### 7. 搜索医院
**接口：** `GET /hospitals/search`

**功能描述：** 根据关键词搜索医院，支持医院名称模糊匹配

**请求参数：**
- `q` (必需): 搜索关键词
- `limit` (可选): 返回结果数量限制，默认20

**请求示例：**
```
GET /hospitals/search?q=人民医院&limit=10
GET /hospitals/search?q=广州医院&limit=50
```

**响应示例：**
```json
{
  "query": "人民医院",
  "limit": 10,
  "results": [
    {
      "id": 10001,
      "name": "广东省人民医院",
      "district_id": 3001,
      "level": "三级甲等",
      "address": "广州市越秀区中山二路106号",
      "phone": "020-83827812"
    }
  ],
  "count": 1
}
```

**使用场景：**
- 快速查找特定医院
- 医院名称模糊搜索
- 移动端医院查询功能

---

## 数据刷新接口

### 8. 完整数据刷新
**接口：** `POST /refresh/all`

**功能描述：** 执行全国范围的完整数据刷新，包括所有省份、城市、区县和医院的层级数据

**执行流程：**
1. 调用LLM获取全国所有省级行政区划
2. 对每个省份自动调用省份数据刷新接口
3. 获取每个省份下的所有城市数据
4. 获取每个城市下的所有区县数据
5. 确保完整层级关系的正确性

**请求参数：** 无

**响应示例：**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "完整数据刷新任务已创建，正在后台处理中...",
  "created_at": "2025-11-23T15:00:00"
}
```

**特点：**
- 覆盖全国所有省级行政区划
- 自动化批量处理
- 完整的四级数据体系（省→市→区县→医院）
- 支持断点续传，失败的省份可以单独重试

**使用场景：**
- 初始化系统数据
- 定期全量数据更新
- 数据修复和完整性检查

**注意事项：**
- 这是一个长时间运行的后台任务
- 建议在系统负载较低时执行
- 可以通过 task_id 查询任务进度

---

### 9. 省份数据刷新
**接口：** `POST /refresh/province/{province_name}`

**功能描述：** 根据省份名称刷新该省份下的城市数据

**路径参数：**
- `province_name`: 省份名称（中文），如"广东省"、"浙江省"等

**执行流程：**
1. 调用LLM获取指定省份下的所有地级市、自治州、地区等
2. 检查省份是否存在，不存在则创建新省份记录
3. 批量创建获取到的所有城市记录
4. 确保数据的完整性和正确性

**请求示例：**
```
POST /refresh/province/广东省
POST /refresh/province/浙江省
```

**响应示例：**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440001",
  "message": "省份 广东省 数据刷新任务已创建，正在后台处理中...",
  "created_at": "2025-11-23T15:05:00"
}
```

**特点：**
- 仅处理省份和城市数据，不处理区县和医院
- 自动去重：避免重复创建相同城市记录
- 详细日志记录每个步骤的执行情况

**使用场景：**
- 新增省份的数据采集
- 特定省份的城市数据更新
- 省级行政区划变更后的数据同步

---

### 10. 区县医院数据刷新
**接口：** `POST /refresh/district/{district_name}`

**功能描述：** 根据区县名称刷新该区县内的所有医院数据

**路径参数：**
- `district_name`: 区县名称（中文），如"朝阳区"、"海淀区"等

**执行流程：**
1. 验证区县是否存在于数据库中
2. 调用LLM获取区县内所有医院的详细信息
3. 自动识别医院等级（三甲、三乙、二甲等）
4. 获取医院联系方式（地址、电话、网站）
5. 智能去重，避免重复创建相同医院记录

**请求示例：**
```
POST /refresh/district/朝阳区
POST /refresh/district/海淀区
```

**响应示例：**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440002",
  "message": "区县 朝阳区 医院数据刷新任务已创建，正在后台处理中...",
  "created_at": "2025-11-23T15:10:00"
}
```

**功能特性：**
- 调用阿里百炼LLM获取区县内所有医院的详细信息
- 自动识别医院等级和类型
- 获取完整的联系方式信息
- 智能去重机制
- 异步后台处理

**使用场景：**
- 特定区域医疗资源普查
- 医院信息定期更新
- 新开发区域的医疗数据采集

---

### 11. 省份城市区县级联刷新
**接口：** `POST /refresh/province-cities-districts/{province_name}`

**功能描述：** 根据省份名称级联刷新该省份下所有城市、区县数据，为医院数据采集做准备

**路径参数：**
- `province_name`: 省份名称（中文）

**执行流程：**
1. 获取指定省份下的所有城市列表
2. 对每个城市检查是否存在，不存在则创建
3. 获取每个城市下的所有区县
4. 创建区县记录并建立完整的层级关系
5. 验证数据的完整性和一致性

**请求示例：**
```
POST /refresh/province-cities-districts/广东省
POST /refresh/province-cities-districts/江苏省
```

**响应示例：**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440003",
  "message": "省份 广东省 的城市、区县及医院数据级联刷新任务已创建，正在后台处理中...",
  "created_at": "2025-11-23T15:15:00"
}
```

**特性：**
- 不对输入省份名称进行验证，支持任意省份名称
- 自动去重：避免重复创建相同记录
- 详细日志：记录每个步骤的执行情况
- 异步处理：后台执行级联刷新任务

**与省份数据刷新的区别：**
- 本接口处理完整的省份→城市→区县数据链
- 省份数据刷新接口仅处理省份和城市数据

**使用场景：**
- 完整省份的行政区划数据采集
- 为后续医院数据采集建立基础框架
- 省级数据完整性检查和修复

---

### 12. 全国扫描 - 所有省份级联刷新
**接口：** `POST /refresh/all-provinces`

**功能描述：** 启动全国范围的医院数据扫描，级联刷新所有省份的城市、区县和医院数据

**执行逻辑：**
1. 首先从LLM获取全国所有省份列表
2. 依次对每个省份执行级联刷新（包含城市、区县、医院）
3. 使用串行处理避免过度并发导致API限流
4. 提供详细的进度日志和错误处理

**请求参数：** 无

**响应示例：**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440004",
  "message": "全国扫描任务已启动，将依次扫描所有省份的城市、区县和医院数据",
  "created_at": "2025-11-23T15:20:00"
}
```

**特性：**
- 🌍 覆盖全国所有省级行政区
- 📊 实时进度跟踪和详细日志记录
- 🔁 自动重试机制和错误恢复
- ⚡ 智能任务队列管理
- 🛡️ API限流保护和并发控制

**使用示例：**
```python
# 启动全国扫描
response = client.post("/refresh/all-provinces")
task_id = response.json()["task_id"]

# 查询进度
status = client.get(f"/tasks/{task_id}")
progress = status.json()["data"]["progress"]
```

**使用场景：**
- 系统初始化时的全国数据采集
- 定期全量数据更新（建议月度或季度）
- 全国医疗资源普查
- 数据完整性验证和修复

**注意事项：**
- 这是耗时最长的操作，可能需要数小时完成
- 建议在系统负载较低的时间段执行
- 任务过程中可以实时查询进度
- 失败的省份会记录详细错误信息，可单独重试

---

## 任务状态查询

所有数据刷新接口都会返回一个 `task_id`，可以通过以下方式查询任务执行状态：

**查询接口：** `GET /task/{task_id}`

**响应示例：**
```json
{
  "code": 200,
  "message": "获取任务状态成功",
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "running",
    "progress": "正在处理第 15/34 个省份：湖北省",
    "created_at": "2025-11-23T15:00:00",
    "updated_at": "2025-11-23T15:45:30"
  }
}
```

**任务状态说明：**
- `pending`: 等待执行
- `running`: 正在执行
- `completed`: 执行完成
- `failed`: 执行失败
- `cancelled`: 已取消

---

## 错误处理

### 通用错误响应格式
```json
{
  "detail": "错误描述信息"
}
```

### 常见错误码
- `400`: 请求参数错误
- `404`: 资源不存在
- `409`: 任务冲突（如重复的全国扫描任务）
- `500`: 服务器内部错误

### 中文参数编码
所有支持中文参数的接口都已正确处理URL编码，可以直接使用中文字符：

```
# 正确的请求示例
GET /cities?province=广东省
GET /districts?city=广州市
GET /hospitals?district=越秀区
POST /refresh/province/广东省
POST /refresh/district/朝阳区
```

---

## 使用建议

### 最佳实践
1. **初始化流程**：先调用 `/refresh/all` 获取省份数据，再调用 `/refresh/all-provinces` 获取完整数据
2. **增量更新**：定期调用特定区域的刷新接口进行数据更新
3. **监控任务**：使用返回的 `task_id` 监控长时间运行的任务状态
4. **错误处理**：检查任务状态，对失败的任务进行重试

### 性能考虑
- 避免频繁调用全国范围的数据刷新接口
- 合理设置分页参数，避免单次返回过多数据
- 在系统负载较低时执行大规模数据刷新操作